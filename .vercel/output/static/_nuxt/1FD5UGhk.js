import{d as A,c as l}from"./CQA7Wwdt.js";import{h as p,l as n,a as m}from"./DzHiA6Ss.js";const E={AUTH_USER:"auth.user",AUTH_LOADING:"auth.loading",THEME:"app.theme",COLABORADORES_CACHE:"colaboradores.cache",LAST_UPDATE:"data.lastUpdate"},u={ADMIN:"admin",PORTEIRO:"porteiro",VISUALIZADOR:"visualizador"},S={COLABORADORES:300*1e3,HISTORICO:600*1e3,USER_SESSION:1440*60*1e3};class h{static instance;static getInstance(){return h.instance||(h.instance=new h),h.instance}set(e,a,o){const s={data:a,timestamp:Date.now(),ttl:o||0};try{localStorage.setItem(e,JSON.stringify(s))}catch(d){console.error("Erro ao salvar no cache:",d)}}get(e){try{const a=localStorage.getItem(e);if(!a)return null;const o=JSON.parse(a);return o.ttl&&Date.now()-o.timestamp>o.ttl?(this.remove(e),null):o.data}catch(a){return console.error("Erro ao ler cache:",a),null}}remove(e){try{localStorage.removeItem(e)}catch(a){console.error("Erro ao remover do cache:",a)}}clear(){try{localStorage.clear()}catch(e){console.error("Erro ao limpar cache:",e)}}has(e){return this.get(e)!==null}}const w=h.getInstance();async function y(r,e,a){const o=w.get(r);if(o!==null)return o;const s=await e();return w.set(r,s,a),s}const C=A("colaboradores",{state:()=>({colaboradores:[],funcionariosPresentes:[],loading:!1,error:null,lastUpdate:null,filters:{}}),getters:{colaboradoresFiltrados:r=>{let e=r.colaboradores;return r.filters.nome&&(e=e.filter(a=>a.nome?.toLowerCase().includes(r.filters.nome.toLowerCase()))),r.filters.funcao&&(e=e.filter(a=>a.funcao?.toLowerCase().includes(r.filters.funcao.toLowerCase()))),r.filters.filial&&(e=e.filter(a=>a.filial?.toLowerCase().includes(r.filters.filial.toLowerCase()))),r.filters.matricula&&(e=e.filter(a=>a.matricula===r.filters.matricula)),e},estatisticas:r=>({totalColaboradores:r.colaboradores.length,funcionariosPresentes:r.funcionariosPresentes.length,funcionariosAusentes:r.colaboradores.length-r.funcionariosPresentes.length,percentualPresenca:r.colaboradores.length>0?Math.round(r.funcionariosPresentes.length/r.colaboradores.length*100):0}),shouldRefresh:r=>{if(!r.lastUpdate)return!0;const e=new Date().getTime(),a=r.lastUpdate.getTime();return e-a>S.COLABORADORES}},actions:{async fetchColaboradores(r=!1){if(!r&&!this.shouldRefresh&&this.colaboradores.length>0)return this.colaboradores;this.loading=!0,this.error=null;try{const e=await y(E.COLABORADORES_CACHE,async()=>{const a=l(),{data:o,error:s}=await a.from("colaboradores").select("*").order("nome",{ascending:!0});if(s)throw s;return o||[]},r?0:S.COLABORADORES);return this.colaboradores=e,this.lastUpdate=new Date,this.atualizarFuncionariosPresentes(),e}catch(e){const a=p(e,"ColaboradoresStore.fetchColaboradores");throw this.error=a.userMessage,n.error("Erro no store:",a.userMessage),e}finally{this.loading=!1}},async fetchColaboradorById(r){const e=this.colaboradores.find(a=>a.id===r);if(e)return e;try{const a=l(),{data:o,error:s}=await a.from("colaboradores").select("*").eq("id",r).single();if(s)throw s;return o}catch(a){const o=p(a,"ColaboradoresStore.fetchColaboradorById");throw n.error("Erro ao buscar colaborador:",o.userMessage),a}},async criarColaborador(r){this.loading=!0,this.error=null;try{const e=l(),{data:a,error:o}=await e.from("colaboradores").insert([r]).select().single();if(o)throw o;return this.colaboradores.push(a),this.invalidarCache(),a}catch(e){const a=p(e,"ColaboradoresStore.criarColaborador");throw this.error=a.userMessage,n.error("Erro ao criar colaborador:",a.userMessage),e}finally{this.loading=!1}},async registrarEntrada(r,e){this.loading=!0,this.error=null;try{const a=l();let o=this.colaboradores.find(t=>t.nome?.toLowerCase()===r.toLowerCase());if(!o){const{data:t,error:c}=await a.from("colaboradores").insert([{nome:r,funcao:e}]).select().single();if(c)throw c;o=t,this.colaboradores.push(o)}const s={},d=new Date().toISOString();for(let t=1;t<=5;t++){const c=`ent${t}`,b=`sai${t}`;if(!o[c]||o[b]){s[c]=d,o[b]&&(s[b]=null);break}}if(Object.keys(s).length===0)throw new Error("Limite de entradas excedido para hoje");const{data:f,error:g}=await a.from("colaboradores").update(s).eq("id",o.id).select().single();if(g)throw g;const i=this.colaboradores.findIndex(t=>t.id===o.id);return i!==-1&&(this.colaboradores[i]=f),this.atualizarFuncionariosPresentes(),this.invalidarCache(),f}catch(a){const o=p(a,"ColaboradoresStore.registrarEntrada");throw this.error=o.userMessage,n.error("Erro ao registrar entrada:",o.userMessage),a}finally{this.loading=!1}},async registrarSaida(r){this.loading=!0,this.error=null;try{const e=l(),a=this.colaboradores.find(i=>i.id===r);if(!a)throw new Error("Colaborador não encontrado");const o={},s=new Date().toISOString();for(let i=5;i>=1;i--){const t=`ent${i}`,c=`sai${i}`;if(a[t]&&!a[c]){o[c]=s;break}}if(Object.keys(o).length===0)throw new Error("Nenhuma entrada em aberto encontrada");const{data:d,error:f}=await e.from("colaboradores").update(o).eq("id",r).select().single();if(f)throw f;const g=this.colaboradores.findIndex(i=>i.id===r);return g!==-1&&(this.colaboradores[g]=d),this.atualizarFuncionariosPresentes(),this.invalidarCache(),d}catch(e){const a=p(e,"ColaboradoresStore.registrarSaida");throw this.error=a.userMessage,n.error("Erro ao registrar saída:",a.userMessage),e}finally{this.loading=!1}},atualizarFuncionariosPresentes(){this.funcionariosPresentes=this.colaboradores.filter(r=>{for(let e=1;e<=5;e++){const a=r[`ent${e}`],o=r[`sai${e}`];if(a&&!o)return!0}return!1})},setFiltros(r){this.filters={...r}},limparFiltros(){this.filters={}},invalidarCache(){w.remove(E.COLABORADORES_CACHE),this.lastUpdate=null},limparDados(){this.colaboradores=[],this.funcionariosPresentes=[],this.error=null,this.lastUpdate=null,this.invalidarCache()}}}),R=A("auth",{state:()=>({user:null,loading:!1,initialized:!1}),getters:{isAuthenticated:r=>!!r.user,userRole:r=>r.user?.role||null,hasPermission:r=>e=>r.user?.role?({[u.ADMIN]:["view_dashboard","manage_users","manage_colaboradores","view_reports","export_data","manage_system"],[u.PORTEIRO]:["view_dashboard","manage_colaboradores","view_reports"],[u.VISUALIZADOR]:["view_dashboard","view_reports"]}[r.user.role]||[]).includes(e):!1,isAdmin:r=>r.user?.role===u.ADMIN,isPorteiro:r=>r.user?.role===u.PORTEIRO,isVisualizador:r=>r.user?.role===u.VISUALIZADOR},actions:{async initialize(){if(!this.initialized){this.loading=!0;try{const r=l(),{data:{session:e},error:a}=await r.auth.getSession();a?(n.error("Erro ao obter sessão:",a),this.user=null):e?.user&&await this.setUser(e.user),r.auth.onAuthStateChange(async(o,s)=>{n.debug("Auth state changed:",o),s?.user?await this.setUser(s.user):this.user=null}),this.initialized=!0}catch(r){n.error("Erro ao inicializar autenticação:",r),this.user=null}finally{this.loading=!1}}},async login(r){this.loading=!0;try{const e=l(),{data:a,error:o}=await e.auth.signInWithPassword({email:r.email,password:r.password});if(o)throw new Error(o.message);return a.user&&await this.setUser(a.user),{success:!0}}catch(e){const a=m(e,"AuthStore.login");return n.error("Erro no login:",a?.userMessage),{success:!1,error:a?.userMessage||"Erro ao fazer login"}}finally{this.loading=!1}},async logout(){this.loading=!0;try{const r=l(),{error:e}=await r.auth.signOut();if(e){const o=m(e,"AuthStore.logout");n.error("Erro ao fazer logout:",o?.userMessage)}return this.user=null,C().limparDados(),{success:!0}}catch(r){const e=m(r,"AuthStore.logout");return n.error("Erro inesperado no logout:",e?.userMessage),{success:!1,error:e?.userMessage||"Erro ao fazer logout"}}finally{this.loading=!1}},async setUser(r){try{const e=l(),{data:a}=await e.from("user_profiles").select("*").eq("user_id",r.id).single();this.user={id:r.id,email:r.email,created_at:r.created_at,updated_at:r.updated_at,role:a?.role||u.VISUALIZADOR,profile:a||null}}catch(e){console.error("Erro ao definir usuário:",e),this.user={id:r.id,email:r.email,created_at:r.created_at,updated_at:r.updated_at,role:u.VISUALIZADOR}}},async updateProfile(r){if(!this.user)throw new Error("Usuário não autenticado");this.loading=!0;try{const e=l(),{data:a,error:o}=await e.from("user_profiles").upsert({user_id:this.user.id,...r,updated_at:new Date().toISOString()}).select().single();if(o)throw o;return this.user&&(this.user.profile=a),{success:!0}}catch(e){return console.error("Erro ao atualizar perfil:",e),{success:!1,error:e?.message||"Erro ao atualizar perfil"}}finally{this.loading=!1}},canAccessRoute(r){return this.isAuthenticated?r.some(e=>this.hasPermission(e)):!1},clearAuth(){this.user=null,this.loading=!1,this.initialized=!1}}});export{R as u};
